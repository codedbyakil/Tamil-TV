name: Build main.m3u (Tamil + Zee + Local)

# ‚úÖ Trigger ONLY after your first workflow succeeds
on:
  workflow_run:
    workflows: ["Auto-Update Tamil M3U"]   # ‚Üê exact name from your first YAML
    types: [completed]
  workflow_dispatch:   # ‚Üê keep this if you want to run manually via UI

# ‚ö†Ô∏è IMPORTANT: workflow_run does NOT grant token permissions automatically
permissions:
  contents: write

jobs:
  build:
    # ‚úÖ Only run if the triggering workflow succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          # üîë Use GITHUB_TOKEN with write access
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main

      - name: Verify required files
        run: |
          for f in tamil.m3u zee.m3u local.m3u; do
            if [ ! -f "$f" ]; then
              echo "‚ùå Missing: $f ‚Äî did 'Auto-Update Tamil M3U' fail to generate tamil.m3u?"
              exit 1
            fi
          done
          echo "‚úÖ All source files present."

      - name: Normalize line endings & encoding
        run: |
          sudo apt-get update && sudo apt-get install -y dos2unix
          for f in tamil.m3u zee.m3u local.m3u; do
            sed -i '1s/^\xEF\xBB\xBF//' "$f"      # Remove BOM
            dos2unix "$f" 2>/dev/null || sed -i 's/\r$//' "$f"
            sed -i 's/[ \t]*$//' "$f"
          done

      - name: Build main.m3u
        run: |
          OUTPUT="main.m3u"
          echo "#EXTM3U x-tvg-url=\"https://iptv-org.github.io/epg/guides/tamil.xml\"" > "$OUTPUT"

          # 1Ô∏è‚É£ tamil.m3u (preserve existing groups)
          echo "# === tamil.m3u (original) ===" >> "$OUTPUT"
          awk '
            /^#EXTM3U/ { next }
            { print }
          ' tamil.m3u >> "$OUTPUT"

          # 2Ô∏è‚É£ zee.m3u ‚Üí Tamil group
          echo "" >> "$OUTPUT"
          echo "# === zee.m3u ‚Üí Tamil group ===" >> "$OUTPUT"
          awk '
            BEGIN { in_extinf = 0; group = "Tamil" }
            /^#EXTM3U/ { next }
            /^#EXTINF:/ {
              in_extinf = 1;
              line = $0;
              if (line ~ /group-title="[^"]*"/) {
                gsub(/group-title="[^"]*"/, "group-title=\"" group "\"", line);
              } else {
                sub(/(-1[ \t]+)/, "\\1group-title=\"" group "\" ", line);
              }
              print line; next;
            }
            in_extinf && /^[^#]/ { print; in_extinf = 0; next; }
            !/^#EXTM3U/ && length($0) > 0 { print }
          ' zee.m3u >> "$OUTPUT"

          # 3Ô∏è‚É£ local.m3u ‚Üí Local Channels group
          echo "" >> "$OUTPUT"
          echo "# === local.m3u ‚Üí Local Channels ===" >> "$OUTPUT"
          awk '
            BEGIN { in_extinf = 0; group = "Local Channels" }
            /^#EXTM3U/ { next }
            /^#EXTINF:/ {
              in_extinf = 1;
              line = $0;
              if (line ~ /group-title="[^"]*"/) {
                gsub(/group-title="[^"]*"/, "group-title=\"" group "\"", line);
              } else {
                sub(/(-1[ \t]+)/, "\\1group-title=\"" group "\" ", line);
              }
              print line; next;
            }
            in_extinf && /^[^#]/ { print; in_extinf = 0; next; }
            !/^#EXTM3U/ && length($0) > 0 { print }
          ' local.m3u >> "$OUTPUT"

          # Stats
          TAMIL=$(grep -c '^#EXTINF.*group-title="Tamil"' "$OUTPUT")
          LOCAL=$(grep -c '^#EXTINF.*group-title="Local Channels"' "$OUTPUT")
          TOTAL=$(grep -c '^#EXTINF' "$OUTPUT")
          echo "‚úÖ main.m3u built:"
          echo "   üéØ Tamil (tamil + zee): $TAMIL"
          echo "   üè† Local Channels: $LOCAL"
          echo "   üì∫ Total: $TOTAL"

      - name: Commit main.m3u
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add main.m3u

          if git diff --cached --quiet; then
            echo "‚û°Ô∏è No change in main.m3u ‚Äî skipping commit"
            exit 0
          fi

          git commit -m "üì∫ main.m3u: $TAMIL Tamil + $LOCAL Local | $(date -u '+%Y-%m-%d %H:%M')"
          git push origin main
