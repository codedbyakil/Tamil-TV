name: Build main.m3u (Tamil + Zee + Local) ‚Äî Correct Order & Names

on:
  workflow_run:
    workflows: ["Auto-Update Tamil M3U"]
    types: [completed]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main

      - name: Verify files
        run: |
          for f in tamil.m3u zee.m3u local.m3u; do
            [ -f "$f" ] || { echo "‚ùå $f missing"; exit 1; }
          done
          echo "‚úÖ All files present."

      - name: Normalize files
        run: |
          sudo apt-get update && sudo apt-get install -y dos2unix
          for f in tamil.m3u zee.m3u local.m3u; do
            sed -i '1s/^\xEF\xBB\xBF//' "$f"
            dos2unix "$f" 2>/dev/null || sed -i 's/\r$//' "$f"
            sed -i 's/[ \t]*$//' "$f"
          done

      - name: Build main.m3u with exact priority order
        run: |
          OUTPUT="main.m3u"
          echo "#EXTM3U x-tvg-url=\"https://iptv-org.github.io/epg/guides/tamil.xml\"" > "$OUTPUT"
          TMP=$(mktemp -d)

          # === Step 1: Extract all Tamil-category blocks (tamil.m3u + zee.m3u) ===
          {
            awk '/^#EXTINF:/ {f=1;block=$0;next} f {block=block"\n"$0} /^[ \t]*http/ {f=0;print "---BLOCK---\n"block; block=""}' tamil.m3u
            awk '/^#EXTINF:/ {f=1;block=$0;next} f {block=block"\n"$0} /^[ \t]*http/ {f=0;print "---BLOCK---\n"block; block=""}' zee.m3u
          } > "$TMP/tamil_blocks.txt"

          # === Step 2: Priority list (simple keys) ===
          cat > "$TMP/priority_simple.txt" <<'EOF'
sun tv
ktv
star vijay
zee tamil
colors tamil
polimer tv
kalaignar tv
vijay super
zee Thirai
sun life
adithya tv
sun music
jaya tv
jaya plus
jaya max
j movies
raj tv
vasanth tv
d tamil
history hd
disney
hungama
cartoon network
pogo
sonic
disney junior
super hungama
discovery kids
EOF

          # === Step 3: Sort & Number ===
          awk -v prio="$TMP/priority_simple.txt" '
            function norm(s,    t) {
              t = tolower(s);
              gsub(/[^a-z0-9]/, "", t);
              return t;
            }

            BEGIN {
              # Load priority keys ‚Üí index
              while ((getline line < prio) > 0) {
                gsub(/^[ \t]+|[ \t]+$/, "", line);
                if (line == "") continue;
                key = norm(line);
                prio_idx[key] = ++n;
              }
              close(prio);
            }

            /^---BLOCK---/ {
              if (block != "") process(block);
              block = ""; next;
            }
            { block = (block == "" ? $0 : block "\n" $0); }
            END { if (block != "") process(block); }

            function process(blk,    lines, n, extinf, name_raw, name_norm, i) {
              n = split(blk, lines, /\n/);
              for (i = 1; i <= n; i++) {
                if (lines[i] ~ /^#EXTINF:/) {
                  extinf = lines[i];
                  match(extinf, /,[^,]*$/);
                  if (RSTART > 0) {
                    name_raw = substr(extinf, RSTART + 1);
                    gsub(/^[ \t"'\''"]+|[ \t"'\''"]+$/, "", name_raw);
                  } else {
                    name_raw = "Unknown";
                  }
                  break;
                }
              }
              if (!extinf) return;

              name_norm = norm(name_raw);
              found = 0;
              for (key in prio_idx) {
                # Try fuzzy match: if key is substring of name_norm (e.g., "zeetamil" in "zeetamilhd")
                if (index(name_norm, key) == 1 || index(name_norm, key) > 0) {
                  # Prefer exact or prefix match
                  if (name_norm == key || index(name_norm, key) == 1) {
                    bucket[key] = (bucket[key] ? bucket[key] "\n---\n" : "") blk;
                    found = 1;
                    break;
                  }
                }
              }
              if (!found) unsorted = (unsorted ? unsorted "\n---\n" : "") blk;
            }

            END {
              # Output in priority order
              chno = 1;
              while ((getline line < prio) > 0) {
                gsub(/^[ \t]+|[ \t]+$/, "", line);
                if (line == "") continue;
                key = norm(line);
                if (key in bucket) {
                  n = split(bucket[key], arr, /---\n/);
                  for (i = 1; i <= n; i++) {
                    gsub(/^\n+/, "", arr[i]);
                    if (arr[i] != "") {
                      output_block(arr[i], chno);
                      chno++;
                    }
                  }
                }
              }
              # Append unmatched
              if (unsorted != "") {
                n = split(unsorted, arr, /---\n/);
                for (i = 1; i <= n; i++) {
                  gsub(/^\n+/, "", arr[i]);
                  if (arr[i] != "") {
                    output_block(arr[i], chno);
                    chno++;
                  }
                }
              }
            }

            function output_block(blk, num,    lines, n, i) {
              n = split(blk, lines, /\n/);
              for (i = 1; i <= n; i++) {
                if (lines[i] ~ /^#EXTINF:/) {
                  gsub(/tvg-chno="[^"]*"/, "", lines[i]);
                  gsub(/tvg-chno=[^, \t]*/, "", lines[i]);
                  if (match(lines[i], /,[^,]*$/)) {
                    pre = substr(lines[i], 1, RSTART - 1);
                    suf = substr(lines[i], RSTART);
                    lines[i] = pre " tvg-chno=\"" num "\"" suf;
                  } else {
                    lines[i] = lines[i] " tvg-chno=\"" num "\"";
                  }
                }
                print lines[i];
              }
              print "";
            }
          ' "$TMP/tamil_blocks.txt" >> "$OUTPUT"

          # === Step 4: Local channels (A‚ÜíZ) ===
          echo "# === Local Channels (A‚ÜíZ) ===" >> "$OUTPUT"
          awk '
            BEGIN { block = ""; }
            /^#EXTINF:/ { if (block) blocks[++cnt]=block; block=$0; next }
            block { block = block "\n" $0 }
            /^[ \t]*http/ { in_url = 1 }
            in_url && /^[^ \t#]/ { in_url = 0 }
            END { if (block) blocks[++cnt]=block }

            function name_key(b,    lines, n, i, s) {
              n = split(b, lines, /\n/);
              for (i=1; i<=n; i++) if (lines[i] ~ /^#EXTINF:/) {
                match(lines[i], /,[^,]*$/);
                if (RSTART>0) {
                  s = substr(lines[i], RSTART+1);
                  gsub(/^[ \t"'\''"]+|[ \t"'\''"]+$/, "", s);
                  return tolower(s);
                }
              }
              return "zzz";
            }

            END {
              for (i=1; i<=cnt; i++) keys[i]=name_key(blocks[i]);
              for (i=1; i<=cnt; i++) idx[i]=i;
              for (i=1; i<=cnt; i++) for (j=i+1; j<=cnt; j++)
                if (keys[idx[i]] > keys[idx[j]]) {
                  tmp=idx[i]; idx[i]=idx[j]; idx[j]=tmp;
                }
              for (i=1; i<=cnt; i++) {
                b = blocks[idx[i]];
                gsub(/tvg-chno="[^"]*"/, "", b);
                gsub(/tvg-chno=[^, \t]*/, "", b);
                if (match(b, /^#EXTINF:[^\n]*/)) {
                  pre = substr(b, 1, RSTART+RLENGTH-1);
                  rest = substr(b, RSTART+RLENGTH);
                  b = pre " tvg-chno=\"L" i "\"" rest;
                }
                print b "\n";
              }
            }
          ' local.m3u >> "$OUTPUT"

          # Stats
          TAMIL=$(awk '/group-title="Tamil"/ && /^#EXTINF/ {c++} END {print c+0}' "$OUTPUT")
          LOCAL=$(awk '/group-title="Local Channels"/ && /^#EXTINF/ {c++} END {print c+0}' "$OUTPUT")
          echo "‚úÖ Built: $TAMIL Tamil (ordered), $LOCAL Local (A‚ÜíZ)"
          rm -rf "$TMP"

      - name: Commit main.m3u
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add main.m3u
          if git diff --cached --quiet; then
            echo "‚û°Ô∏è No changes"
            exit 0
          fi
          T=$(awk '/group-title="Tamil"/ && /^#EXTINF/ {c++} END {print c+0}' main.m3u)
          L=$(awk '/group-title="Local Channels"/ && /^#EXTINF/ {c++} END {print c+0}' main.m3u)
          git commit -m "üì∫ main.m3u: $T Tamil (#1‚Äì#${T}) + $L Local (A‚ÜíZ)"
          git push origin main
