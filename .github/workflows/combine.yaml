name: Enhance Tamil M3U (Merge Zee)

on:
  workflow_run:
    workflows: ["Auto-Update Tamil M3U"]
    types: [completed]
  workflow_dispatch:

jobs:
  enhance:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y dos2unix

      - name: Verify files
        run: |
          [ -f tamil.m3u ] && echo "✅ tamil.m3u exists" || { echo "❌ MISSING"; exit 1; }
          [ -f zee.m3u ] && echo "✅ zee.m3u exists" || { echo "❌ MISSING"; exit 1; }

      - name: Normalize zee.m3u
        run: |
          sed -i '1s/^\xEF\xBB\xBF//' zee.m3u
          dos2unix zee.m3u 2>/dev/null || sed -i 's/\r$//' zee.m3u
          sed -i 's/[ \t]*$//' zee.m3u

      - name: Merge zee.m3u into tamil.m3u (Tamil group)
        run: |
          # Extract Zee channels with correct group
          ZEE_CHANNELS=$(awk '
            BEGIN { in_extinf = 0 }
            /^#EXTINF:/ {
              in_extinf = 1;
              line = $0;
              gsub(/group-title="[^"]*"/, "group-title=\"Tamil\"", line);
              if (line !~ /group-title="Tamil"/) sub(/(-1[ \t]+)/, "\\1group-title=\"Tamil\" ", line);
              print line;
              next;
            }
            in_extinf && /^[^#]/ { print; in_extinf = 0; next }
            /^[^#]/ { in_extinf = 0 }
            { if (!in_extinf && length($0)) print }
          ' zee.m3u)

          # Append to tamil.m3u
          echo "" >> tamil.m3u
          echo "# === MERGED FROM zee.m3u ===" >> tamil.m3u
          echo "$ZEE_CHANNELS" >> tamil.m3u

          echo "✅ Appended $(echo "$ZEE_CHANNELS" | grep -c '^#EXTINF') Zee channels to tamil.m3u"

      - name: Commit enhanced tamil.m3u
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add tamil.m3u
          if git diff --cached --quiet; then
            echo "➡️ No effective change — skipping commit"
            exit 0
          fi
          git commit -m "✨ Merged zee.m3u → tamil.m3u (Tamil group)"
          git push origin main
