name: Build main.m3u (Tamil + Zee + Local)

on:
  workflow_run:
    workflows: ["Auto-Update Tamil M3U"]
    types: [completed]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main

      - name: Verify files
        run: |
          for f in tamil.m3u zee.m3u local.m3u; do
            if [ ! -f "$f" ]; then
              echo "âŒ $f missing â€” aborting"
              exit 1
            fi
          done
          echo "âœ… All required files present."

      - name: Normalize line endings & clean BOM
        run: |
          sudo apt-get update && sudo apt-get install -y dos2unix
          for f in tamil.m3u zee.m3u local.m3u; do
            sed -i '1s/^\xEF\xBB\xBF//' "$f"      # Remove UTF-8 BOM
            dos2unix "$f" 2>/dev/null || sed -i 's/\r$//' "$f"  # CRLF â†’ LF
            sed -i 's/[ \t]*$//' "$f"             # Trim trailing whitespace
          done

      - name: ğŸ” Debug zee.m3u (structure check)
        run: |
          echo "ğŸ” Sample of zee.m3u (first 12 lines, escaped):"
          head -n 12 zee.m3u | cat -A

      - name: Build main.m3u
        run: |
          OUTPUT="main.m3u"
          echo "#EXTM3U x-tvg-url=\"https://iptv-org.github.io/epg/guides/tamil.xml\"" > "$OUTPUT"

          # 1ï¸âƒ£ tamil.m3u â€” pass-through (skip #EXTM3U)
          echo "# === tamil.m3u ===" >> "$OUTPUT"
          awk '
            /^#EXTM3U/ { next }
            NF == 0 { next }
            { print }
          ' tamil.m3u >> "$OUTPUT"

          # 2ï¸âƒ£ âœ… zee.m3u â€” Preserve logos & attributes; force group-title="Tamil"
          echo "" >> "$OUTPUT"
          echo "# === zee.m3u â†’ Tamil (logos preserved) ===" >> "$OUTPUT"
          awk '
            BEGIN { in_extinf = 0; extinf_line = ""; }

            /^#EXTINF:/ {
              in_extinf = 1;
              extinf_line = $0;
              next;
            }

            in_extinf && /^[ \t]*http/ {
              url = $0;
              gsub(/^[ \t]+|[ \t]+$/, "", url);
              if (length(url) == 0) { next; }

              # âœ… Preserve all attributes, but ensure group-title="Tamil"
              # Remove existing group-title if any, then add ours at end
              gsub(/group-title="[^"]*"/, "", extinf_line);
              gsub(/group-title=[^, \t]*/, "", extinf_line);  # no quotes variant
              
              # Ensure no trailing space before comma
              gsub(/ +,/, ",", extinf_line);
              
              # Inject group-title="Tamil" before the final comma+name part
              # Match: everything up to the final comma (channel name separator)
              if (match(extinf_line, /,[^,]*$/)) {
                prefix = substr(extinf_line, 1, RSTART - 1);
                suffix = substr(extinf_line, RSTART);
                # Insert group-title at end of attributes (before comma)
                new_extinf = prefix " group-title=\"Tamil\"" suffix;
                print new_extinf;
                print url;
              } else {
                # Fallback: append group-title before comma
                print extinf_line " group-title=\"Tamil\"";
                print url;
              }

              in_extinf = 0;
              extinf_line = "";
              next;
            }

            # Skip non-matching lines (comments, props, blank lines)
            { next; }
          ' zee.m3u >> "$OUTPUT"

          # 3ï¸âƒ£ local.m3u â€” group-title="Local Channels", preserve logos
          echo "" >> "$OUTPUT"
          echo "# === local.m3u â†’ Local Channels (logos preserved) ===" >> "$OUTPUT"
          awk '
            BEGIN { in_extinf = 0; extinf_line = ""; }

            /^#EXTINF:/ {
              in_extinf = 1;
              extinf_line = $0;
              next;
            }

            in_extinf && /^[ \t]*http/ {
              url = $0;
              gsub(/^[ \t]+|[ \t]+$/, "", url);
              if (length(url) == 0) { next; }

              gsub(/group-title="[^"]*"/, "", extinf_line);
              gsub(/group-title=[^, \t]*/, "", extinf_line);
              gsub(/ +,/, ",", extinf_line);

              if (match(extinf_line, /,[^,]*$/)) {
                prefix = substr(extinf_line, 1, RSTART - 1);
                suffix = substr(extinf_line, RSTART);
                new_extinf = prefix " group-title=\"Local Channels\"" suffix;
                print new_extinf;
                print url;
              } else {
                print extinf_line " group-title=\"Local Channels\"";
                print url;
              }

              in_extinf = 0;
              extinf_line = "";
              next;
            }
            { next; }
          ' local.m3u >> "$OUTPUT"

          # ğŸ“Š Stats
          TAMIL=$(grep -c '^#EXTINF:-1.*group-title="Tamil"' "$OUTPUT" 2>/dev/null || echo 0)
          LOCAL=$(grep -c '^#EXTINF:-1.*group-title="Local Channels"' "$OUTPUT" 2>/dev/null || echo 0)
          TOTAL=$((TAMIL + LOCAL))
          echo "âœ… main.m3u built with $TOTAL channels:"
          echo "   ğŸ¯ Tamil (incl. Zee): $TAMIL"
          echo "   ğŸ  Local Channels: $LOCAL"

          # Optional: show first few Zee entries
          echo ""
          echo "ğŸ“Œ First 3 Zee-derived entries:"
          awk '/# === zee\.m3u/,/# === local\.m3u/ { if (/^#EXTINF/ || /^http/) print "  " $0 }' "$OUTPUT" | head -n 6

      - name: Commit main.m3u
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add main.m3u

          if git diff --cached --quiet; then
            echo "â¡ï¸ No changes â€” skipping commit"
            exit 0
          fi

          git commit -m "ğŸ“º main.m3u: $TAMIL Tamil (incl. Zee w/ logos) + $LOCAL Local"
          git push origin main
