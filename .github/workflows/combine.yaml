name: Build main.m3u (Tamil + Zee + Local)

on:
  workflow_run:
    workflows: ["Auto-Update Tamil M3U"]
    types: [completed]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main

      - name: Verify files
        run: |
          for f in tamil.m3u zee.m3u local.m3u; do
            [ -f "$f" ] || { echo "‚ùå $f missing"; exit 1; }
          done
          echo "‚úÖ All files present."

      - name: Normalize files
        run: |
          sudo apt-get update && sudo apt-get install -y dos2unix
          for f in tamil.m3u zee.m3u local.m3u; do
            sed -i '1s/^\xEF\xBB\xBF//' "$f"     # Remove BOM
            dos2unix "$f" 2>/dev/null || sed -i 's/\r$//' "$f"
            sed -i 's/[ \t]*$//' "$f"            # Trim trailing space
          done

      - name: üîç Debug zee.m3u (first 8 lines)
        run: |
          echo "üîç zee.m3u (first 8 lines, escaped):"
          head -n 8 zee.m3u | cat -A

      - name: Build main.m3u
        run: |
          OUTPUT="main.m3u"
          echo "#EXTM3U x-tvg-url=\"https://iptv-org.github.io/epg/guides/tamil.xml\"" > "$OUTPUT"

          # 1Ô∏è‚É£ tamil.m3u ‚Äî keep as-is (skip #EXTM3U)
          echo "# === tamil.m3u ===" >> "$OUTPUT"
          awk '
            /^#EXTM3U/ { next }
            NF == 0 { next }
            { print }
          ' tamil.m3u >> "$OUTPUT"

          # 2Ô∏è‚É£ ‚úÖ zee.m3u ‚Äî robust parsing, force group-title="Tamil", fix #EXTINF:-1
          echo "" >> "$OUTPUT"
          echo "# === zee.m3u ‚Üí Tamil ===" >> "$OUTPUT"
          awk '
            BEGIN { in_extinf = 0; channel_name = ""; }
            /^#EXTINF:/ {
              in_extinf = 1;
              # Extract everything after the last comma (channel name)
              i = match($0, /,[^,]*$/);
              if (i > 0) {
                channel_name = substr($0, i + 1);
                gsub(/^[ \t"]+|[ \t"]+$/, "", channel_name);
              } else {
                channel_name = "Zee Channel";
              }
              next;
            }
            in_extinf && /^[^#]/ && length($0) > 0 {
              url = $0;
              # ‚úÖ CORRECT FORMAT: #EXTINF:-1 group-title="Tamil",Name
              print "#EXTINF:-1 group-title=\"Tamil\"," channel_name;
              print url;
              in_extinf = 0;
              channel_name = "";
              next;
            }
            # Skip all other lines (comments, props, cookies ‚Äî add later if needed)
          ' zee.m3u >> "$OUTPUT"

          # 3Ô∏è‚É£ local.m3u ‚Äî same logic, group="Local Channels"
          echo "" >> "$OUTPUT"
          echo "# === local.m3u ‚Üí Local Channels ===" >> "$OUTPUT"
          awk '
            BEGIN { in_extinf = 0; channel_name = ""; }
            /^#EXTINF:/ {
              in_extinf = 1;
              i = match($0, /,[^,]*$/);
              if (i > 0) {
                channel_name = substr($0, i + 1);
                gsub(/^[ \t"]+|[ \t"]+$/, "", channel_name);
              } else {
                channel_name = "Local Channel";
              }
              next;
            }
            in_extinf && /^[^#]/ && length($0) > 0 {
              url = $0;
              print "#EXTINF:-1 group-title=\"Local Channels\"," channel_name;
              print url;
              in_extinf = 0;
              channel_name = "";
              next;
            }
          ' local.m3u >> "$OUTPUT"

          # Stats
          TAMIL=$(grep -c '^#EXTINF:-1 group-title="Tamil"' "$OUTPUT" || echo 0)
          LOCAL=$(grep -c '^#EXTINF:-1 group-title="Local Channels"' "$OUTPUT" || echo 0)
          echo "‚úÖ main.m3u built:"
          echo "   üéØ Tamil (tamil + zee): $TAMIL"
          echo "   üè† Local Channels: $LOCAL"

      - name: Commit main.m3u
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add main.m3u
          if git diff --cached --quiet; then
            echo "‚û°Ô∏è No change ‚Äî skipping commit"
            exit 0
          fi
          git commit -m "üì∫ main.m3u: $TAMIL Tamil + $LOCAL Local"
          git push origin main
