name: Enhance Tamil M3U (Merge Zee + Preserve Local)

permissions:
  contents: write

on:
  workflow_dispatch:
  schedule:
    - cron: '*/30 * * * *'   # runs every 30 mins, after your first workflow likely finished

jobs:
  enhance:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify required files
        run: |
          for f in tamil.m3u zee.m3u local.m3u; do
            if [ ! -f "$f" ]; then
              echo "‚ùå Missing required file: $f"
              exit 1
            fi
          done
          echo "‚úÖ All files present."

      - name: Enhance tamil.m3u with Zee channels (‚Üí Tamil group)
        run: |
          TEMP_TAMIL=$(mktemp)
          TEMP_ZEE=$(mktemp)

          # 1Ô∏è‚É£ Copy existing tamil.m3u ‚Äî keep header and all lines as-is
          cp tamil.m3u "$TEMP_TAMIL"

          # 2Ô∏è‚É£ Process zee.m3u: force all channels into group-title="Tamil"
          awk '
            BEGIN { in_extinf = 0 }
            /^#EXTINF:/ {
              in_extinf = 1;
              line = $0;
              # Ensure group-title="Tamil" ‚Äî insert or replace
              if (line ~ /group-title="[^"]*"/) {
                gsub(/group-title="[^"]*"/, "group-title=\"Tamil\"", line);
              } else {
                # Insert after "-1 " (standard position)
                sub(/(-1[ \t]+)/, "\\1group-title=\"Tamil\" ", line);
              }
              print line;
              next;
            }
            in_extinf && /^[^#]/ {
              # This is the URL line ‚Üí print and reset
              print $0;
              in_extinf = 0;
              next;
            }
            # Pass through other directive lines (KODIPROP, EXTHTTP, UA, etc.)
            /^[^#]/ { in_extinf = 0 }  # reset on bare URL (shouldn‚Äôt happen here)
            { if (!in_extinf && length($0) > 0) print }
          ' zee.m3u > "$TEMP_ZEE"

          # 3Ô∏è‚É£ Append Zee channels to tamil.m3u
          echo "" >> "$TEMP_TAMIL"   # blank line for readability
          echo "# === Zee Channels (merged into Tamil group) ===" >> "$TEMP_TAMIL"
          cat "$TEMP_ZEE" >> "$TEMP_TAMIL"

          # 4Ô∏è‚É£ Replace tamil.m3u with enhanced version
          mv "$TEMP_TAMIL" tamil.m3u

          # 5Ô∏è‚É£ Stats
          TAMIL_ORIG=$(grep -c '^#EXTINF.*group-title="Tamil"' tamil.m3u 2>/dev/null | head -n1 || echo 0)
          ZEE_COUNT=$(grep -c '^#EXTINF' "$TEMP_ZEE" || echo 0)
          echo "üéØ Enhanced tamil.m3u:"
          echo "   ‚ûï Original Tamil channels: $TAMIL_ORIG"
          echo "   ‚ûï Zee channels added: $ZEE_COUNT"
          echo "   üì¶ Total in 'Tamil' group: $(($TAMIL_ORIG + $ZEE_COUNT))"

      - name: Generate final playlist (tamil + local)
        run: |
          OUTPUT="playlist.m3u"
          echo "#EXTM3U" > "$OUTPUT"

          # Add enhanced tamil.m3u (now includes Zee)
          echo "‚û°Ô∏è Adding enhanced tamil.m3u (Tamil group)..."
          cat tamil.m3u >> "$OUTPUT"

          # Add local.m3u as "Local Channels"
          echo "‚û°Ô∏è Adding local.m3u as 'Local Channels'..."
          awk '
            BEGIN { in_extinf = 0; group = "Local Channels" }
            /^#EXTINF:/ {
              in_extinf = 1;
              line = $0;
              if (line ~ /group-title=/) {
                gsub(/group-title="[^"]*"/, "group-title=\"" group "\"", line);
              } else {
                sub(/(-1[ \t]+)/, "\\1group-title=\"" group "\" ", line);
              }
              print line;
              next;
            }
            in_extinf && /^[^#]/ {
              print $0;
              in_extinf = 0;
              next;
            }
            { if (!in_extinf && length($0) > 0) print }
          ' local.m3u >> "$OUTPUT"

          # Stats
          TOTAL_TAMIL=$(grep -c '^#EXTINF.*group-title="Tamil"' "$OUTPUT" || echo 0)
          TOTAL_LOCAL=$(grep -c '^#EXTINF.*group-title="Local Channels"' "$OUTPUT" || echo 0)
          echo "‚úÖ playlist.m3u created:"
          echo "   üéØ Tamil (incl. Zee): $TOTAL_TAMIL"
          echo "   üè† Local Channels: $TOTAL_LOCAL"

      - name: Commit changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Stage both updated tamil.m3u and new playlist.m3u
          git add tamil.m3u playlist.m3u

          if git diff --cached --quiet; then
            echo "‚û°Ô∏è No changes ‚Äî skipping commit"
            exit 0
          fi

          git commit -m "‚ú® Enhance: merged zee.m3u ‚Üí tamil.m3u (Tamil group), + local ‚Üí playlist.m3u | $(date -u '+%Y-%m-%d %H:%M')"
          git push origin main
