name: Auto-Update Tamil M3U

permissions:
  contents: write

on:
  workflow_dispatch:
  schedule:
    - cron: '*/30 * * * *'

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Generate tamil.m3u
        run: |
          echo "üì• Fetching Ziotv.json..."
          JSON_URL="https://playify.pages.dev/Ziotv.json"
          JSON=$(curl -sf \
            -H "User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36" \
            -H "Accept: application/json" \
            -H "Referer: https://playify.pages.dev/" \
            "$JSON_URL") || { echo "‚ùå Failed to fetch JSON"; exit 1; }

          if [ -z "$JSON" ] || [ "${JSON:0:1}" = "<" ]; then
            echo "‚ùå Response is empty or HTML"
            exit 1
          fi

          echo "#EXTM3U" > tamil.m3u

          echo "$JSON" | jq -r '
            # Normalize structure
            def normalize:
              if type == "array" then .
              elif type == "object" then
                if has("channels") and (.channels | type == "array") then .channels
                elif has("data") and (.data | type == "array") then .data
                elif has("list") and (.list | type == "array") then .list
                elif (.[] | type == "object") then [.[]]
                else []
                end
              else []
              end;

            # Clean name for matching
            def clean_name:
              (.name // .title // .channel_name // "") |
              ascii_downcase |
              gsub("\\s+"; " ") |
              gsub("( hd| sd| ‚Ä¢|:| - .*| \\(.*?\\)| \\[.*?\\]| hd$| sd$| tv$| channel$)"; "") |
              gsub("^\\s+|\\s+$"; "");

            # ‚úÖ Exact allowlist (normalized)
            def in_allowlist:
              clean_name as $n |
              [
                "sun",                  # covers Sun TV, Sun News, Sun Music, Sun Life
                "star vijay",
                "zee tamil",
                "colors tamil",
                "ktv",
                "vijay super",
                "zee thirai",
                "chutti",
                "adithya",
                "j movies",
                "jaya plus",
                "polimer",
                "vasanth",
                "kalaignar",
                "jaya",
                "raj tv",
                "disney",
                "hungama",
                "disney junior",
                "sonic",
                "nickelodeon",
                "pogo",
                "cartoon network",
                "sony yay"
              ] as $list |
              ($list | map(select($n | contains(.))) | length > 0) or
              # Also include any news channel from known Tamil brands
              ($n | contains("news") and (
                $n | contains("sun") or contains("kalaignar") or
                contains("polimer") or contains("jaya") or
                contains("raj tv") or contains("than") or
                contains("adithya") or contains("vasanth")
              ));

            normalize |
            map(select(type == "object")) |
            map(
              .clean_name = clean_name
            ) |
            # Filter by allowlist + has link
            map(select(
              (.link // .url // "") != "" and in_allowlist
            )) |
            # Deduplicate by clean_name (keep first)
            group_by(.clean_name) |
            map(.[0]) |
            .[] |

            (.name // .title // "Unknown") as $orig_name |
            (.tvg_id // .tvgId // .id // "") as $tvg_id |
            (.tvg_logo // .logo // .icon // "") as $tvg_logo |
            (.drmScheme // .drm_scheme // .drm // "") as $drmScheme |
            (.drmLicense // .license // "") as $drmLicense |
            (.cookie // .cookies // "") as $cookie |
            (.link // .url // .stream_url // .hls // .mpd // "") as $link |

            "#EXTINF:-1 " +
              (if ($tvg_id | length > 0) then "tvg-id=\"\($tvg_id)\" " else "" end) +
              "group-title=\"Tamil\" " +
              (if ($tvg_logo | length > 0) then "tvg-logo=\"\($tvg_logo)\" " else "" end) +
              ",\($orig_name | gsub(","; "\\,"))" |
            . as $extinf |

            (if ($drmScheme == "clearkey") and ($drmLicense | test("^[a-zA-Z0-9]+:[a-zA-Z0-9]+")) then
              "#KODIPROP:inputstream.adaptive.license_type=clearkey\n#KODIPROP:inputstream.adaptive.license_key=" + 
              ($drmLicense | split(":")[0:2] | join(":"))
            else "" end) as $drm |

            "#EXTVLCOPT:http-user-agent=plaYtv/7.1.5%20(Linux%3BAndroid%2015)%20ExoPlayerLib/2.11.6%20YGX/69.69.69.69" as $ua |

            (if ($cookie | length > 0) then
              "#EXTHTTP:{\"cookie\":\"" + ($cookie | gsub("\""; "\\\"")) + "\"}"
            else "" end) as $cookie_line |

            [
              $extinf,
              ($drm | select(. != "")),
              $ua,
              ($cookie_line | select(. != "")),
              $link
            ] | join("\n")
          ' >> tamil.m3u

          # Final check
          LINE_COUNT=$(wc -l < tamil.m3u)
          CHANNEL_COUNT=$(grep -c "^#EXTINF" tamil.m3u)
          if [ "$LINE_COUNT" -le 1 ]; then
            echo "‚ùå tamil.m3u empty ‚Äî checking allowlist matches..."
            echo "$JSON" | jq -r '
              normalize |
              map(select(type == "object")) |
              .[] |
              clean_name as $cn |
              (.name // .title // "‚Äì") + " ‚Üí " + $cn +
              (if in_allowlist then " ‚úÖ" else " ‚ùå" end)
            ' 2>/dev/null | head -n 20
            exit 1
          fi

          echo "‚úÖ tamil.m3u created: $CHANNEL_COUNT channels ($LINE_COUNT lines)"
          echo "üìã Channels included:"
          grep "^#EXTINF" tamil.m3u | sed 's/.*,//' | sort

      - name: Commit & Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add tamil.m3u

          if git diff --cached --quiet; then
            echo "‚û°Ô∏è No changes ‚Äî skipping commit"
            exit 0
          fi

          git commit -m "‚úÖ Auto-update Tamil M3U: $CHANNEL_COUNT channels | $(date -u '+%Y-%m-%d %H:%M')"
          git push origin main
